name: Deploy Bootstrap Node

on:
  push:
    branches:
      - main
    paths:
      - "bootstrap/**"
      - "Cargo.toml"
  workflow_dispatch:

env:
  BINARY_NAME: swarm-bootstrap
  ECS_HOST: 47.115.172.218
  ECS_USER: root
  DEPLOY_DIR: /opt/swarm-bootstrap

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2

      - name: Install musl tools
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Add musl target
        run: rustup target add x86_64-unknown-linux-musl

      - name: Build release
        run: cargo build --release --target x86_64-unknown-linux-musl -p ${{ env.BINARY_NAME }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}
          path: target/x86_64-unknown-linux-musl/release/${{ env.BINARY_NAME }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: bootstrap/swarm-bootstrap.service

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}

      - name: Deploy binary
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.ECS_HOST }}
          username: ${{ env.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          source: ${{ env.BINARY_NAME }}
          target: ${{ env.DEPLOY_DIR }}/

      - name: Deploy service file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.ECS_HOST }}
          username: ${{ env.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          source: bootstrap/swarm-bootstrap.service
          target: /etc/systemd/system/
          strip_components: 1

      - name: Restart service
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.ECS_HOST }}
          username: ${{ env.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          script: |
            chmod +x ${{ env.DEPLOY_DIR }}/${{ env.BINARY_NAME }}
            systemctl daemon-reload
            systemctl enable swarm-bootstrap
            systemctl restart swarm-bootstrap || true
